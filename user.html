<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>กิจกรรมของฉัน</title>
  <link rel="stylesheet" href="style.css">

  <!-- jsQR (สำหรับอ่าน QR Code) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- Firebase SDK (Compat Version) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Firebase Config -->
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="user-container">
    <h2>ยินดีต้อนรับ <span id="userName">ธนภัทร</span></h2>

    <input id="newName" placeholder="เปลี่ยนชื่อใหม่">
    <button id="changeNameBtn">เปลี่ยนชื่อ</button>

    <h3>สถิติกิจกรรม</h3>
    <ul>
      <li>เข้าแถวหน้าเสาธง: <span id="attendCount">0</span></li>
      <li>ทำความสะอาด: <span id="cleanCount">0</span></li>
      <li>ครั้งที่จัดกิจกรรมแถว: <span id="eventAttendCount">0</span></li>
      <li>ครั้งที่จัดกิจกรรมความสะอาด: <span id="eventCleanCount">0</span></li>
    </ul>

    <button id="scanBtn">เปิดกล้องสแกน QR</button>
    <video id="video" style="width:100%; max-width:400px;" hidden autoplay playsinline></video>
  </div>

  <script>
    const db = firebase.firestore();

    const video = document.getElementById("video");
    let stream = null;

    document.getElementById("scanBtn").addEventListener("click", scanQR);

    function scanQR() {
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(mediaStream => {
          stream = mediaStream;
          video.srcObject = stream;
          video.hidden = false;
          video.play();
          startScanLoop();
        })
        .catch(err => {
          alert("ไม่สามารถเปิดกล้องได้: " + err.message);
          console.error(err);
        });
    }

    function startScanLoop() {
      const canvasElement = document.createElement("canvas");
      const canvas = canvasElement.getContext("2d");

      async function scanFrame() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvasElement.width = video.videoWidth;
          canvasElement.height = video.videoHeight;
          canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
          const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);

          const code = jsQR(imageData.data, imageData.width, imageData.height);

          if (code) {
            alert("สแกนได้: " + code.data);
            stopScan();

            const username = document.getElementById("userName").textContent.trim();
            const usersRef = db.collection("users");
            const query = usersRef.where("username", "==", username);
            const querySnapshot = await query.get();

            if (querySnapshot.empty) {
              alert("ไม่พบชื่อผู้ใช้ในระบบ");
              return;
            }

            const userDoc = querySnapshot.docs[0];
            const data = userDoc.data();

            if (code.data === "attend") {
              await userDoc.ref.update({ attend: (data.attend || 0) + 1 });
            } else if (code.data === "clean") {
              await userDoc.ref.update({ clean: (data.clean || 0) + 1 });
            } else {
              alert("QR code ไม่ถูกต้อง");
              return;
            }

            alert("อัปเดตกิจกรรมสำเร็จ");
            location.reload();
          }
        }
        requestAnimationFrame(scanFrame);
      }

      requestAnimationFrame(scanFrame);
    }

    function stopScan() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.hidden = true;
    }
  </script>
</body>
</html>
